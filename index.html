<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Network Community Viz</title>

  <!-- Core Cytoscape -->
  <script src="https://unpkg.com/cytoscape@3/dist/cytoscape.min.js"></script>

  <style>
    html, body { margin:0; padding:0; height:100%; }
    #cy { width:100%; height:100%; }
    #legend {
      position:absolute; top:10px; right:10px;
      background:rgba(255,255,255,0.9); padding:6px;
      font:12px sans-serif; white-space:pre-line;
      border:1px solid #ccc; border-radius:4px;
      max-width:200px;
    }
  </style>
</head>
<body>
  <div id="cy"></div>
  <div id="legend"></div>

  <script>
  (function(){
    // fallback sample data
    const sample = {
      tables:{ DEFAULT:[
        { dimensions:[
            "Company","ACME","http://acme","NY","1998","500","$10M","http://acme",
            "Partnership","Research Center","BioLab"
          ], metrics:[3] },
        { dimensions:[
            "Company","Foo","http://foo","LA","2005","120","$2M","http://foo",
            "Joint Venture","University","UniTech"
          ], metrics:[5] },
        { dimensions:[
            "Research Center","Bar","http://bar","Boston","2010","80","$1.2M","http://bar",
            "Collaboration","Company","ACME"
          ], metrics:[2] },
        { dimensions:[
            "University","UniLab","http://unilab","Cambridge","1870","1500","$200M","http://unilab",
            "Acquisition","Company","MegaCorp"
          ], metrics:[4] }
      ]}
    };

    function draw(data) {
      const nodes = {}, edges = [];

      data.tables.DEFAULT.forEach(r => {
        const d=r.dimensions, m=r.metrics;
        if(!nodes[d[1]]) nodes[d[1]]={ data:{ id:d[1], label:d[1], degree:0 }};
        if(!nodes[d[10]])nodes[d[10]]={ data:{ id:d[10], label:d[10], degree:0 }};
        edges.push({ data:{ id:`${d[1]}â†’${d[10]}`, source:d[1], target:d[10], weight:+m[0] }});
        nodes[d[1]].data.degree++; nodes[d[10]].data.degree++;
      });

      const cy = cytoscape({
        container: document.getElementById('cy'),
        elements: { nodes:Object.values(nodes), edges },
        style: [
          {
            selector:'node',
            style:{
              'background-color':'#3399ff',
              'width':n=>10+n.data('degree')*2,
              'height':n=>10+n.data('degree')*2,
              'label':'data(label)', 'font-size':10
            }
          },
          {
            selector:'edge',
            style:{
              'width':'mapData(weight,0,10,1,6)',
              'line-color':'#999',
              'target-arrow-shape':'triangle'
            }
          }
        ],
        layout:{
          name:'cose',      // <- built-in layout!
          fit:true,
          padding:30,
          animate:true
        }
      });

      cy.on('mouseover','node',evt=>{
        const d=evt.target.data();
        document.getElementById('legend').innerText = `${d.label}\nConnections: ${d.degree}`;
      });
      cy.on('mouseout','node',()=>document.getElementById('legend').innerText='');
      cy.on('tap','node',evt=>window.open(evt.target.data('link'),'_blank'));
    }

    // run fallback on load
    window.addEventListener('load', () => draw(sample));
  })();
  </script>
</body>
</html>
