<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Network Community Viz</title>
  <!-- 1) Load Cytoscape + fcose (Force-Atlas2–like) -->
  <script src="https://unpkg.com/cytoscape@3/dist/cytoscape.min.js"></script>
  <script src="https://unpkg.com/cytoscape-fcose@1.2.0/cytoscape-fcose.js"></script>
  <style>
    body, html { margin:0; padding:0; height:100%; }
    #cy { width:100%; height:100%; }
    #legend {
      position:absolute;
      top:10px;
      right:10px;
      background:white;
      padding:6px;
      font:12px sans-serif;
      white-space: pre-line;
    }
  </style>
</head>
<body>
  <div id="cy"></div>
  <div id="legend"></div>

  <script>
  (function() {
    const dscc = window.dscc;
    const chart = {};

    chart.draw = function(data) {
      const nodes = {};
      const edges = [];

      data.tables.DEFAULT.forEach(row => {
        const d = row.dimensions; // [0..10]
        const m = row.metrics;    // [0] = Weight

        // Source node
        if (!nodes[d[1]]) {
          nodes[d[1]] = {
            data: {
              id:      d[1],
              label:   d[1],
              type:    d[0],
              website: d[2],
              hq:      d[3],
              founded: d[4],
              emp:     d[5],
              rev:     d[6],
              link:    d[7],
              degree:  0
            }
          };
        }

        // Target node
        if (!nodes[d[10]]) {
          nodes[d[10]] = {
            data: {
              id:     d[10],
              label:  d[10],
              type:   d[9],
              degree: 0
            }
          };
        }

        // Edge
        edges.push({
          data: {
            id:     `${d[1]}→${d[10]}`,
            source: d[1],
            target: d[10],
            type:   d[8],
            weight: +m[0]
          }
        });

        // Degree count
        nodes[d[1]].data.degree++;
        nodes[d[10]].data.degree++;
      });

      const elements = {
        nodes: Object.values(nodes),
        edges: edges
      };

      // Initialize or update Cytoscape instance
      let cy = window._cyInstance;
      if (!cy) {
        cy = cytoscape({
          container: document.getElementById('cy'),
          elements:  elements,
          style: [
            {
              selector: 'node',
              style: {
                'background-color': node => {
                  const colormap = {
                    'Company':         '#3399ff',
                    'University':      '#33cc33',
                    'Research Center': '#ff9933'
                  };
                  return colormap[node.data('type')] || '#999999';
                },
                'width':  node => 10 + node.data('degree')*2,
                'height': node => 10 + node.data('degree')*2,
                'label':  'data(label)',
                'font-size': 8
              }
            },
            {
              selector: 'edge',
              style: {
                'width': 'mapData(weight, 0, 10, 1, 6)',
                'line-color': edge => {
                  const cmap = {
                    'Partnership':    '#1f77b4',
                    'Joint Venture':  '#ff7f0e',
                    'Acquisition':    '#2ca02c',
                    'Collaboration':  '#d62728'
                  };
                  return cmap[ edge.data('type') ] || '#999999';
                },
                'target-arrow-shape': 'triangle',
                'target-arrow-color': edge => {
                  const cmap = {
                    'Partnership':    '#1f77b4',
                    'Joint Venture':  '#ff7f0e',
                    'Acquisition':    '#2ca02c',
                    'Collaboration':  '#d62728'
                  };
                  return cmap[ edge.data('type') ] || '#999999';
                }
              }
            }
          ],
          layout: {
            name:     'fcose',
            quality:  'proof',
            randomize:true
          }
        });
        window._cyInstance = cy;
      } else {
        cy.elements().remove();
        cy.add(elements);
        cy.layout({ name:'fcose', quality:'proof', randomize:true }).run();
      }

      // Tooltips
      cy.on('mouseover', 'node', evt => {
        const d = evt.target.data();
        document.getElementById('legend').innerText =
          `${d.label}\nType: ${d.type}\nFounded: ${d.founded}\nEmployees: ${d.emp}\nRevenue: ${d.rev}`;
      });
      cy.on('mouseout', 'node', () => {
        document.getElementById('legend').innerText = '';
      });

      // Click to drill
      cy.on('tap', 'node', evt => {
        const url = evt.target.data('link');
        if (url) window.open(url, '_blank');
      });
    };

    if (dscc && dscc.register) {
      dscc.register({ draw: chart.draw });
    }
  })();
  </script>
</body>
</html>
// === LOCAL PREVIEW FALLBACK ===
if (!window.dscc) {
  const sample = {
    tables: {
      DEFAULT: [
        // Edge #1: ACME Co. → BioLab
        {
          dimensions: [
            "Company","ACME Co.","http://acme.io","NYC","1998","500","$10M","http://acme.io",
            "Partnership","Research Center","BioLab"
          ],
          metrics: [ 3 ]
        },
        // Edge #2: FooCorp → UniTech
        {
          dimensions: [
            "Company","FooCorp","http://foocorp.com","LA","2005","120","$2M","http://foocorp.com",
            "Joint Venture","University","UniTech"
          ],
          metrics: [ 5 ]
        },
        // Edge #3: Bar Labs → ACME Co.
        {
          dimensions: [
            "Research Center","Bar Labs","http://barlabs.org","Boston","2010","80","$1.2M","http://barlabs.org",
            "Collaboration","Company","ACME Co."
          ],
          metrics: [ 2 ]
        }
      ]
    }
  };
  window.addEventListener('load', () => chart.draw(sample));
}
