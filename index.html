<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Network Community Viz</title>

<!-- 1) Load Cytoscape core -->
<script src="https://unpkg.com/cytoscape@3/dist/cytoscape.min.js"></script>

<!-- 2) Load the cose-bilkent UMD bundle -->
<script src="https://unpkg.com/cytoscape-cose-bilkent@4/cytoscape-cose-bilkent.umd.js"></script>

<!-- 3) Register cose-bilkent plugin once -->
<script>
  // cytoscapeCoseBilkent is exposed by the UMD build
  if (window.cytoscapeCoseBilkent) {
    cytoscape.use(window.cytoscapeCoseBilkent);
    console.log('‚úÖ cose-bilkent plugin registered');
  } else {
    console.warn('‚ö†Ô∏è cose-bilkent plugin missing ‚Äì check your script src');
  }
</script>

  <style>
    html, body { margin:0; padding:0; height:100%; }
    #cy { width:100%; height:100%; display:block; }
    #legend {
      position:absolute; top:10px; right:10px;
      background:rgba(255,255,255,0.9); padding:8px;
      font:12px sans-serif; white-space: pre-line;
      border:1px solid #ddd; border-radius:4px;
      max-width:200px;
    }
  </style>
</head>
<body>
  <div id="cy"></div>
  <div id="legend"></div>

  <script>
  (function(){
    const dscc = window.dscc;
    const chart = {};

    // 4) Build the network from Looker data
    chart.draw = function(data) {
      const nodes = {};
      const edges = [];

      data.tables.DEFAULT.forEach(row => {
        const d = row.dimensions; // 0..10
        const m = row.metrics;    // [0] = weight

        // Source node (From Name)
        if (!nodes[d[1]]) {
          nodes[d[1]] = { data: {
            id:      d[1],
            label:   d[1],
            type:    d[0],  // From Type
            website: d[2],
            hq:      d[3],
            founded: d[4],
            emp:     d[5],
            rev:     d[6],
            link:    d[7],
            degree:  0
          }};
        }

        // Target node (To Name)
        if (!nodes[d[10]]) {
          nodes[d[10]] = { data: {
            id:     d[10],
            label:  d[10],
            type:   d[9],  // To Type
            degree: 0
          }};
        }

        // Edge
        edges.push({ data: {
          id:     `${d[1]}‚Üí${d[10]}`,
          source: d[1],
          target: d[10],
          type:   d[8],   // Edge Type
          weight: +m[0]
        }});

        // Increase degree for sizing
        nodes[d[1]].data.degree++;
        nodes[d[10]].data.degree++;
      });

      const elements = {
        nodes: Object.values(nodes),
        edges: edges
      };

      // Initialize or update Cytoscape
      let cy = window._cyInstance;
      if (!cy) {
        cy = cytoscape({
          container: document.getElementById('cy'),
          elements:  elements,
          style: [
            // Nodes
            {
              selector: 'node',
              style: {
                'background-color': n => {
                  const map = {
                    Company:          '#3399ff',
                    University:       '#33cc33',
                    'Research Center':'#ff9933'
                  };
                  return map[n.data('type')] || '#999999';
                },
                'width':  n => 10 + n.data('degree')*2,
                'height': n => 10 + n.data('degree')*2,
                'label':  'data(label)',
                'font-size': 10,
                'text-valign':'center',
                'text-halign':'center'
              }
            },
            // Edges
            {
              selector: 'edge',
              style: {
                'width': 'mapData(weight, 0, 10, 1, 6)',
                'line-color': e => {
                  const map = {
                    Partnership:    '#1f77b4',
                    'Joint Venture':'#ff7f0e',
                    Acquisition:    '#2ca02c',
                    Collaboration:  '#d62728'
                  };
                  return map[e.data('type')] || '#bbbbbb';
                },
                'target-arrow-shape': 'triangle',
                'target-arrow-color': e => {
                  const map = {
                    Partnership:    '#1f77b4',
                    'Joint Venture':'#ff7f0e',
                    Acquisition:    '#2ca02c',
                    Collaboration:  '#d62728'
                  };
                  return map[e.data('type')] || '#bbbbbb';
                }
              }
            }
          ],
          layout: {
            name:      'cose-bilkent',
            fit:       true,
            padding:   30,
            randomize: true,
            animate:   true
          }
        });
        window._cyInstance = cy;
      } else {
        cy.elements().remove();
        cy.add(elements);
        cy.layout({
          name:      'cose-bilkent',
          fit:       true,
          padding:   30,
          randomize: true,
          animate:   true
        }).run();
      }

      // Hover tooltip
      cy.on('mouseover', 'node', evt => {
        const d = evt.target.data();
        document.getElementById('legend').innerText =
          `${d.label}\nType: ${d.type}\nFounded: ${d.founded}\nEmployees: ${d.emp}\nRevenue: ${d.rev}`;
      });
      cy.on('mouseout', 'node', () => {
        document.getElementById('legend').innerText = '';
      });

      // Click to open link
      cy.on('tap', 'node', evt => {
        const url = evt.target.data('link');
        if (url) window.open(url, '_blank');
      });
    };

    // 5) Register with Looker Studio
    if (dscc && dscc.register) {
      dscc.register({ draw: chart.draw });
    }

    // === LOCAL PREVIEW FALLBACK ===
    if (!window.dscc) {
      console.log('üöÄ fallback running');
      const sample = {
        tables: {
          DEFAULT: [
            {
              dimensions: [
                "Company","ACME Co.","http://acme.io","NYC","1998","500","$10M","http://acme.io",
                "Partnership","Research Center","BioLab"
              ],
              metrics: [3]
            },
            {
              dimensions: [
                "Company","FooCorp","http://foocorp.com","LA","2005","120","$2M","http://foocorp.com",
                "Joint Venture","University","UniTech"
              ],
              metrics: [5]
            },
            {
              dimensions: [
                "Research Center","Bar Labs","http://barlabs.org","Boston","2010","80","$1.2M","http://barlabs.org",
                "Collaboration","Company","ACME Co."
              ],
              metrics: [2]
            },
            {
              dimensions: [
                "University","UniLab","http://unilab.edu","Cambridge","1870","1500","$200M","http://unilab.edu",
                "Acquisition","Company","MegaCorp"
              ],
              metrics: [4]
            },
            {
              dimensions: [
                "Company","StartUpX","http://startupx.com","Berlin","2018","10","$1M","http://startupx.com",
                "Collaboration","Research Center","BioLab"
              ],
              metrics: [2]
            }
          ]
        }
      };
      window.addEventListener('load', () => chart.draw(sample));
    }
  })();
  </script>
</body>
</html>
